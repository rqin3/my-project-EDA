---
title: "EDA_Research_Analysis"
author: "Richard Qin, Kenneth Lim, Sean Lee"
date: "2025-04-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
```

```{r}
library(dplyr)
#Load dataset
dta=read.csv("data/asecpub24csv/clean_data.csv", header=T)
#Loading party affiliation dataset
party=read.csv("data/asecpub24csv/state_political_affliation.csv")
party=party[,c(1,2)]

#Merging the two datasets
new_dta=inner_join(dta, party, by=c("State_Name"="Location"))
colnames(new_dta)[16]="Political_Party"

#Running multinomial regression
multinom_model=multinom(Current_Health_Insurance ~ Political_Party + Binary_Household_Income, data=new_dta)
summary_model=summary(multinom_model)
summary_model

```

```{r}
#Calculating for p-values of the model
z_values=summary_model$coefficients / summary_model$standard.errors
p_values=2 * (1 - pnorm(abs(z_values)))
p_values

```



```{r}
library(knitr)
library(kableExtra)
library(dplyr)
library(gridExtra)
library(grid)

#Extract model outputs
coefs=as.data.frame(as.table(summary_model$coefficients))
ses=as.data.frame(as.table(summary_model$standard.errors))
zvals=as.data.frame(as.table(summary_model$coefficients/summary_model$standard.errors))

#Remove intercepts
coefs=coefs[coefs$Var2!="(Intercept)",]
ses=ses[ses$Var2!="(Intercept)", ]
zvals=zvals[zvals$Var2!="(Intercept)",]

#Rename for merge
names(coefs)[3]="Estimate"
names(ses)[3]="SE"
names(zvals)[3]="z_value"

#Merge into one data frame
results_df=coefs %>%
  left_join(ses[, c("Var1", "Var2", "SE")], by=c("Var1", "Var2")) %>%
  left_join(zvals[, c("Var1", "Var2", "z_value")], by=c("Var1", "Var2"))

# Step 2: Compute OR and 95% CI
results_df=results_df %>%
  mutate(
    Outcome=as.character(Var1),
    Variable=gsub("Binary_Household_Incomebelow \\$82,500", "Income < $82,500", Var2),
    OR=exp(Estimate),
    CI_lower=exp(Estimate - 1.96 * SE),
    CI_upper=exp(Estimate + 1.96 * SE),
    CI=paste0("(", round(CI_lower, 3), ", ", round(CI_upper, 3), ")"),
    z_value=round(z_value, 3),
    p_value=2 * (1 - pnorm(abs(z_value))),
    p_value=format.pval(p_value, digits=4, eps=.Machine$double.eps),
    p_value=gsub("<", "&lt;", p_value),
    Variable=paste0("   ", Variable)
  ) %>%
  select(Outcome, Variable, OR, CI, z_value, p_value)

#Format for display
results_df$OR=round(results_df$OR, 3)
results_df$Outcome=factor(results_df$Outcome, levels=c("None", "Some"))
results_df=results_df %>% arrange(Outcome)
results_df$Outcome=as.character(results_df$Outcome)
results_df$Outcome[duplicated(results_df$Outcome)]=""

#Plot version (unescaped p-value)
plot_df=results_df %>%
  mutate(p_value=gsub("&lt;", "<", p_value))

#Create plot table
title=textGrob("Multinomial Logistic Regression: Health Insurance Coverage",
                  gp=gpar(fontsize=14, fontface="bold"))
table=tableGrob(plot_df, rows=rep("", nrow(plot_df)))
final_plot=arrangeGrob(title, table, ncol=1, heights=c(0.15, 1))

plot(final_plot)


```


```{r}
##Forest Plot
library(ggplot2)

# Create a data frame from your table
df=data.frame(
  Outcome=c("None", "None", "Some", "Some"),
  Variable=c("Republican", "Income < $82,500", "Republican", "Income < $82,500"),
  OR=c(1.495, 4.119, 1.314, 1.316),
  CI_low=c(1.37, 3.71, 1.234, 1.237),
  CI_high=c(1.631, 4.573, 1.398, 1.4)
)

#Create a label column for the y-axis
df=df %>%
  mutate(Label=paste0(Outcome, ": ", Variable))

#Assign the plot to an object
forest_plot=ggplot(df, aes(x=OR, y=reorder(Label, OR))) +
  geom_point(size=3, color="steelblue") +
  geom_errorbarh(aes(xmin=CI_low, xmax=CI_high), height=0.2, color="steelblue") +
  geom_vline(xintercept=1, linetype="dashed", color="red") +
  scale_x_log10() +
  labs(
    x="Odds Ratio",
    y=NULL,
    title="Forest Plot: Odds Ratios for Health Insurance Coverage"
  ) +
  theme_minimal(base_size=14)

forest_plot

#Save the plot
#ggsave("forest_plot_health_insurance.png", plot=p, width=8, height=5, dpi=300, bg="white")

```

